(function(){"use strict";
  function absoluteHref(href){
    try {
      return new URL(href, window.location.href).href;
    } catch (e) {
      return href;
    }
  }

  function buildDocument(contentNode,title){
    const headParts=[];
    document.querySelectorAll('link[rel~="stylesheet"]').forEach(link=>{
      const href=link.getAttribute("href")||link.href;
      if(href) headParts.push(`<link rel="stylesheet" href="${absoluteHref(href)}">`);
    });
    document.querySelectorAll("style").forEach(style=>{
      headParts.push(`<style>${style.textContent}</style>`);
    });
    const safeTitle=title||document.title||"";
    return `<!doctype html><html><head><title>${safeTitle}</title>${headParts.join("")}</head><body>${contentNode.outerHTML}</body></html>`;
  }

  function PdfJob(){
    this.o={};
    this.s=null;
  }

  PdfJob.prototype.set=function(options){
    this.o=Object.assign(this.o,options||{});
    return this;
  };

  PdfJob.prototype.from=function(source){
    this.s=source;
    return this;
  };

  PdfJob.prototype.save=function(){
    return new Promise((resolve,reject)=>{
      try {
        const source=this.s||document.body;
        const cloned=source.cloneNode(true);
        const html=buildDocument(cloned,this.o.filename||document.title);
        const win=window.open("","_blank","noopener,noreferrer");
        if(!win) throw new Error("Popup blocked");
        win.document.open();
        win.document.write(html);
        win.document.close();
        const finalize=()=>{
          try{
            win.focus();
            win.print();
            resolve();
          }catch(err){
            reject(err);
          }
        };
        if(win.document.readyState==="complete"){
          setTimeout(finalize,300);
        }else{
          win.addEventListener("load",()=>setTimeout(finalize,300));
        }
      }catch(err){
        reject(err);
      }
    });
  };

  function html2pdf(){return new PdfJob();}
  html2pdf.version="local-print-stub";
  window.html2pdf=html2pdf;
})();
